#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Snapshot & LLM Logs å¯è¯»æ ¼å¼åŒ–å·¥å…·

åŠŸèƒ½ï¼šå°† snapshot JSON å’Œ LLM åˆ†ææ—¥å¿—è½¬åŒ–ä¸ºç»“æ„åŒ–çš„å¯è¯»æ–‡æœ¬æŠ¥å‘Š
ä½¿ç”¨æ–¹å¼ï¼š
    python format_snapshot.py <snapshot_id>
    python format_snapshot.py --latest
    python format_snapshot.py --all
"""

import json
import os
import sys
from datetime import datetime
from pathlib import Path
from typing import Optional, Dict, Any, List

# ============================================================================
#                              é…ç½®åŒº
# ============================================================================

DATA_DIR = os.getenv("DATA_DIR", "data")
OUTPUT_DIR = os.getenv("OUTPUT_DIR", "formatted_reports")

# ============================================================================
#                           å·¥å…·å‡½æ•°
# ============================================================================

def format_number(value, decimals=4):
    """æ ¼å¼åŒ–æ•°å­—ï¼Œå¤„ç†Noneå’Œç§‘å­¦è®¡æ•°æ³•"""
    if value is None:
        return "N/A"
    if isinstance(value, (int, float)):
        if abs(value) < 0.0001 and value != 0:
            return f"{value:.6f}"
        return f"{value:.{decimals}f}"
    return str(value)

def format_pct(value):
    """æ ¼å¼åŒ–ç™¾åˆ†æ¯”"""
    if value is None:
        return "N/A"
    return f"{value*100:.2f}%"

def get_trend_emoji(value, threshold=0):
    """æ ¹æ®æ•°å€¼è¿”å›è¶‹åŠ¿emoji"""
    if value is None:
        return "â“"
    if value > threshold:
        return "ğŸ“ˆ"
    elif value < -threshold:
        return "ğŸ“‰"
    return "â¡ï¸"

def get_quality_badge(quality):
    """è·å–æ•°æ®è´¨é‡å¾½ç« """
    badges = {
        "good": "âœ…",
        "missing": "âŒ",
        "stale": "âš ï¸"
    }
    return badges.get(quality, "â“")

# ============================================================================
#                         æŠ¥å‘Šç”Ÿæˆå™¨ç±»
# ============================================================================

class SnapshotFormatter:
    """Snapshotæ ¼å¼åŒ–å™¨"""
    
    def __init__(self, snapshot: Dict[str, Any], llm_module_logs: Dict[str, str] = None, llm_overall_log: str = None):
        self.snapshot = snapshot
        self.llm_module_logs = llm_module_logs or {}
        self.llm_overall_log = llm_overall_log
        
    def format_header(self) -> str:
        """ç”ŸæˆæŠ¥å‘Šå¤´éƒ¨"""
        lines = [
            "=" * 100,
            "                   ğŸ“Š å¸‚åœºå¿«ç…§åˆ†ææŠ¥å‘Š (Market Snapshot Report)",
            "=" * 100,
            "",
            f"  ğŸ“… å¿«ç…§æ—¥æœŸ: {self.snapshot.get('date', 'N/A')}",
            f"  ğŸ†” å¿«ç…§ID: {self.snapshot.get('id', 'N/A')}",
            f"  ğŸ• åˆ›å»ºæ—¶é—´: {datetime.fromtimestamp(self.snapshot.get('created_ts', 0)).strftime('%Y-%m-%d %H:%M:%S')}",
            "",
            "=" * 100,
            "",
        ]
        return "\n".join(lines)
    
    def format_labels_summary(self) -> str:
        """ç”Ÿæˆæ ‡ç­¾æ‘˜è¦"""
        labels = self.snapshot.get("labels", {})
        heuristics = self.snapshot.get("heuristics", {})
        
        label_icons = {
            "Dovish": "ğŸ•Šï¸", "Hawkish": "ğŸ¦…", "Neutral": "âš–ï¸",
            "Easing": "ğŸ’§", "Tightening": "ğŸ”’",
            "Risk-On": "ğŸš€", "Risk-Off": "ğŸ›¡ï¸", "Greed": "ğŸ¤‘", "Fear": "ğŸ˜°",
            "Uptrend": "ğŸ“ˆ", "Downtrend": "ğŸ“‰", "Range": "â†”ï¸", "Trending": "ã€°ï¸",
            "Bullish": "ğŸ‚", "Bearish": "ğŸ»", "Balanced": "âš–ï¸",
            "Put_Heavy": "ğŸ”´", "Call_Heavy": "ğŸŸ¢"
        }
        
        lines = [
            "â”Œ" + "â”€" * 98 + "â”",
            "â”‚" + " " * 35 + "ğŸ·ï¸ å¸‚åœºä½“åˆ¶æ ‡ç­¾æ‘˜è¦" + " " * 35 + "â”‚",
            "â”œ" + "â”€" * 98 + "â”¤",
        ]
        
        # ä¸»æ ‡ç­¾
        items = [
            ("å®è§‚æ”¿ç­– (Macro)", labels.get("macro_regime", "Unknown")),
            ("æµåŠ¨æ€§ (Liquidity)", labels.get("liquidity_regime", "Unknown")),
            ("å¸‚åœºæƒ…ç»ª (Sentiment)", labels.get("sentiment_regime", "Unknown")),
            ("æŠ€æœ¯é¢ (Technical)", labels.get("technical_regime", "Unknown")),
        ]
        
        for name, value in items:
            icon = label_icons.get(value, "â“")
            lines.append(f"â”‚  {name:25} â”‚ {icon} {value:15} â”‚")
        
        # è¾…åŠ©æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
        if "options_sentiment" in labels:
            icon = label_icons.get(labels["options_sentiment"], "â“")
            lines.append(f"â”‚  æœŸæƒæƒ…ç»ª (Options)        â”‚ {icon} {labels['options_sentiment']:15} â”‚")
        
        if "iv_skew_signal" in labels:
            icon = label_icons.get(labels["iv_skew_signal"], "â“")
            lines.append(f"â”‚  IVåæ–œ (IV Skew)          â”‚ {icon} {labels['iv_skew_signal']:15} â”‚")
        
        lines.append("â””" + "â”€" * 98 + "â”˜")
        lines.append("")
        
        return "\n".join(lines)
    
    def format_fundamentals(self) -> str:
        """æ ¼å¼åŒ–å®è§‚åŸºæœ¬é¢æ¨¡å—"""
        fund = self.snapshot.get("modules", {}).get("fundamentals", {})
        
        lines = [
            "",
            "â•”" + "â•" * 98 + "â•—",
            "â•‘" + " " * 30 + "ğŸ“Š FUNDAMENTALS (å®è§‚åŸºæœ¬é¢)" + " " * 30 + "â•‘",
            "â•š" + "â•" * 98 + "â•",
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  ğŸ“ˆ åˆ©ç‡æ•°æ® (Interest Rates)                                                                      â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    2å¹´æœŸå›½å€º (DGS2):       {format_number(fund.get('dgs2'), 2):>10}%    (æ—¥æœŸ: {fund.get('dgs2_date', 'N/A')})                            â”‚",
            f"â”‚    10å¹´æœŸå›½å€º (DGS10):     {format_number(fund.get('dgs10'), 2):>10}%    (æ—¥æœŸ: {fund.get('dgs10_date', 'N/A')})                            â”‚",
            f"â”‚    è”é‚¦åŸºé‡‘åˆ©ç‡ (FFR):     {format_number(fund.get('fedfunds'), 2):>10}%    (æ—¥æœŸ: {fund.get('fedfunds_date', 'N/A')})                            â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“‰ åˆ©å·®æŒ‡æ ‡ (Spread Indicators)                                                                   â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
        ]
        
        term_spread = fund.get('term_spread')
        ffr_2y = fund.get('ffr_minus_2y')
        
        lines.extend([
            f"â”‚    æœŸé™åˆ©å·® (10Y-2Y):      {format_number(term_spread, 2):>10}%    {get_trend_emoji(term_spread)} {'æ­£å¸¸æ›²çº¿' if term_spread and term_spread > 0 else 'å€’æŒ‚/å¹³å¦'}          â”‚",
            f"â”‚    æ”¿ç­–åç¦» (FFR-2Y):      {format_number(ffr_2y, 2):>10}%    {get_trend_emoji(ffr_2y)} é™æ¯é¢„æœŸ: {'å¼±' if ffr_2y and ffr_2y < 0.2 else 'å¼º'}      â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ’µ é€šèƒ€ä¸ç¾å…ƒ (Inflation & Dollar)                                                                â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    å®é™…åˆ©ç‡10Y (Real10Y):  {format_number(fund.get('real10y'), 2):>10}%                                                            â”‚",
            f"â”‚    é€šèƒ€é¢„æœŸ10Y (BE10Y):    {format_number(fund.get('breakeven10y'), 2):>10}%                                                            â”‚",
            f"â”‚    ç¾å…ƒæŒ‡æ•° (DXY):         {format_number(fund.get('dxy'), 2):>10}      {get_trend_emoji(100 - (fund.get('dxy') or 100))} {'ç¾å…ƒèµ°å¼±' if fund.get('dxy') and fund.get('dxy') < 100 else 'ç¾å…ƒèµ°å¼º'}               â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“Š ä¿¡ç”¨åˆ©å·® (Credit Spreads)                                                                      â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    æŠ•èµ„çº§OAS (IG_OAS):     {format_number(fund.get('ig_oas'), 2):>10}%                                                            â”‚",
            f"â”‚    é«˜æ”¶ç›ŠOAS (HY_OAS):     {format_number(fund.get('hy_oas'), 2):>10}%                                                            â”‚",
            "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
        ])
        
        # ç»æµäº‹ä»¶
        events = fund.get("events", [])
        if events:
            lines.extend([
                "",
                "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
                "â”‚  ğŸ“… å½“æ—¥é‡è¦ç»æµäº‹ä»¶                                                                               â”‚",
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
                "â”‚  äº‹ä»¶åç§°                        â”‚ é‡è¦æ€§  â”‚  å®é™…å€¼    â”‚  é¢„æœŸå€¼    â”‚  å‰å€¼      â”‚   æ—¶é—´        â”‚",
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            ])
            
            importance_stars = {1: "â­", 2: "â­â­", 3: "â­â­â­"}
            
            # åªæ˜¾ç¤ºé«˜é‡è¦æ€§(2-3)æˆ–å·²æœ‰å®é™…å€¼çš„äº‹ä»¶
            filtered_events = [e for e in events if e.get("importance", 1) >= 2 or e.get("actual")][:10]
            
            for event in filtered_events:
                name = (event.get("event") or "Unknown")[:30]
                imp = importance_stars.get(event.get("importance", 1), "â­")
                actual = str(event.get("actual") or "-")[:10]
                forecast = str(event.get("forecast") or "-")[:10]
                previous = str(event.get("previous") or "-")[:10]
                time = str(event.get("time") or "-")[:13]
                
                lines.append(f"â”‚  {name:32} â”‚ {imp:7} â”‚ {actual:>10} â”‚ {forecast:>10} â”‚ {previous:>10} â”‚ {time:>13} â”‚")
            
            lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        
        # æ–°é—»
        news = fund.get("news", [])
        if news:
            lines.extend([
                "",
                "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
                "â”‚  ğŸ“° ç›¸å…³æ–°é—»                                                                                       â”‚",
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            ])
            for n in news[:5]:
                title = (n.get("title") or "")[:90]
                source = (n.get("source") or "Unknown")[:20]
                lines.append(f"â”‚  â€¢ {title:90} â”‚")
                lines.append(f"â”‚    æ¥æº: {source:20} | æ—¶é—´: {n.get('published', 'N/A')[:30]:30}              â”‚")
            lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        
        return "\n".join(lines)
    
    def format_liquidity(self) -> str:
        """æ ¼å¼åŒ–æµåŠ¨æ€§æ¨¡å—"""
        liq = self.snapshot.get("modules", {}).get("liquidity", {})
        
        net_liq = liq.get("net_liquidity")
        net_change = liq.get("net_change_4w")
        
        lines = [
            "",
            "â•”" + "â•" * 98 + "â•—",
            "â•‘" + " " * 33 + "ğŸ’§ LIQUIDITY (æµåŠ¨æ€§)" + " " * 33 + "â•‘",
            "â•š" + "â•" * 98 + "â•",
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  ğŸ¦ ç¾è”å‚¨èµ„äº§è´Ÿå€ºè¡¨ç»„æˆ                                                                           â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    ç¾è”å‚¨æ€»èµ„äº§ (WALCL):        {format_number(liq.get('walcl'), 2):>12} åäº¿ç¾å…ƒ                                       â”‚",
            f"â”‚    éš”å¤œé€†å›è´­ (RRP):            {format_number(liq.get('rrp'), 2):>12} åäº¿ç¾å…ƒ    {'âš ï¸ å·²è€—å°½!' if liq.get('rrp') is not None and liq.get('rrp') < 1 else ''}                   â”‚",
            f"â”‚    è´¢æ”¿éƒ¨è´¦æˆ· (TGA):            {format_number(liq.get('tga'), 2):>12} åäº¿ç¾å…ƒ                                       â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“Š å‡€æµåŠ¨æ€§è®¡ç®— (Net Liquidity = WALCL - RRP - TGA)                                               â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    å‡€æµåŠ¨æ€§:                    {format_number(net_liq, 2):>12} åäº¿ç¾å…ƒ                                       â”‚",
            f"â”‚    4å‘¨å˜åŒ–:                     {format_number(net_change, 2):>12} åäº¿ç¾å…ƒ    {get_trend_emoji(net_change)} {'æ‰©å¼ ' if net_change and net_change > 0 else 'æ”¶ç¼©'}    â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“ˆ ä¿¡ç”¨é£é™©æŒ‡æ ‡                                                                                    â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    ä¿¡ç”¨æ¯”ç‡ (HYG/IEI):          {format_number(liq.get('credit_ratio'), 4):>12}                                                 â”‚",
            f"â”‚    20æ—¥å˜åŒ–:                    {format_number(liq.get('credit_change_20d'), 4):>12}                                                 â”‚",
            "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
        ]
        
        return "\n".join(lines)
    
    def format_sentiment(self) -> str:
        """æ ¼å¼åŒ–æƒ…ç»ªæ¨¡å—"""
        sent = self.snapshot.get("modules", {}).get("sentiment", {})
        
        fgi = sent.get("fgi_score")
        vix = sent.get("vix")
        vix3m = sent.get("vix3m")
        pcr = sent.get("put_call_ratio")
        
        # FGIé¢œè‰²æ¡
        fgi_bar = self._generate_fgi_bar(fgi)
        
        lines = [
            "",
            "â•”" + "â•" * 98 + "â•—",
            "â•‘" + " " * 33 + "ğŸ˜€ SENTIMENT (å¸‚åœºæƒ…ç»ª)" + " " * 30 + "â•‘",
            "â•š" + "â•" * 98 + "â•",
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  ğŸ­ ææƒ§è´ªå©ªæŒ‡æ•° (Fear & Greed Index)                                                              â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    å½“å‰å¾—åˆ†: {fgi if fgi is not None else 'N/A':>3}/100    è¯„çº§: {sent.get('fgi_rating', 'N/A'):15}    æ¥æº: {sent.get('fgi_source', 'N/A'):15}          â”‚",
            f"â”‚    {fgi_bar}                    â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“Š æ³¢åŠ¨ç‡æŒ‡æ ‡ (Volatility)                                                                        â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    VIX (30å¤©):              {format_number(vix, 2):>10}      {'ğŸŸ¢ ä½æ³¢åŠ¨' if vix and vix < 15 else 'ğŸŸ¡ æ­£å¸¸' if vix and vix < 20 else 'ğŸ”´ é«˜æ³¢åŠ¨'}                                â”‚",
            f"â”‚    VIX3M (3ä¸ªæœˆ):           {format_number(vix3m, 2):>10}                                                            â”‚",
            f"â”‚    æœŸé™ç»“æ„:                {sent.get('term_structure', 'N/A'):>10}      {'ğŸŸ¢ æ­£å¸¸' if sent.get('term_structure') == 'contango' else 'ğŸ”´ ææ…Œä¿¡å·'}                           â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ“ˆ æœŸæƒæŒ‡æ ‡ (Options)                                                                             â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    Put/Callæ¯”ç‡:            {format_number(pcr, 2):>10}      {'ğŸ”´ åç©º' if pcr and pcr > 1.0 else 'ğŸŸ¡ ä¸­æ€§' if pcr and pcr > 0.7 else 'ğŸŸ¢ åå¤š'}                                â”‚",
            f"â”‚    5æ—¥å‡å€¼:                 {format_number(sent.get('put_call_ratio_5d'), 2):>10}                                                            â”‚",
            f"â”‚    20æ—¥å‡å€¼:                {format_number(sent.get('put_call_ratio_20d'), 2):>10}                                                            â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  ğŸ”€ è·¨èµ„äº§é£é™©ä»·å·® (Cross-Asset Risk Spreads)                                                      â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    SPY-XLU (å‘¨æœŸvsé˜²å¾¡):    {format_pct(sent.get('spy_xlu')):>10}      {get_trend_emoji(sent.get('spy_xlu'))} {'Risk-On' if sent.get('spy_xlu') and sent.get('spy_xlu') > 0 else 'Risk-Off'}    â”‚",
            f"â”‚    HYG-IEF (ä¿¡ç”¨é£é™©):      {format_pct(sent.get('hyg_ief')):>10}      {get_trend_emoji(sent.get('hyg_ief'))} {'ä¿¡ç”¨åå¥½' if sent.get('hyg_ief') and sent.get('hyg_ief') > 0 else 'é¿é™©'}         â”‚",
            f"â”‚    BTC-Gold (æŠ•æœºvsé¿é™©):   {format_pct(sent.get('btc_gold')):>10}      {get_trend_emoji(sent.get('btc_gold'))} {'æŠ•æœºåå¥½' if sent.get('btc_gold') and sent.get('btc_gold') > 0 else 'é¿é™©èµ„äº§èµ°å¼º'} â”‚",
            "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
        ]
        
        # å¸‚åœºå¹¿åº¦
        if sent.get("advance_decline_ratio") is not None or sent.get("nyse_advancing") is not None:
            lines.extend([
                "",
                "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
                "â”‚  ğŸ“Š å¸‚åœºå¹¿åº¦ (Market Breadth)                                                                      â”‚",
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
                f"â”‚    NYSE æ¶¨/è·Œ:             {sent.get('nyse_advancing', 'N/A'):>6} / {sent.get('nyse_declining', 'N/A'):<6}                                              â”‚",
                f"â”‚    NASDAQ æ¶¨/è·Œ:           {sent.get('nasdaq_advancing', 'N/A'):>6} / {sent.get('nasdaq_declining', 'N/A'):<6}                                              â”‚",
                f"â”‚    æ¶¨è·Œæ¯”ç‡:               {format_number(sent.get('advance_decline_ratio'), 2):>10}                                                            â”‚",
                f"â”‚    NYSE æ–°é«˜/æ–°ä½:         {sent.get('nyse_new_highs', 'N/A'):>6} / {sent.get('nyse_new_lows', 'N/A'):<6}                                              â”‚",
                f"â”‚    æ–°é«˜æ–°ä½æ¯”ç‡:           {format_number(sent.get('new_high_low_ratio'), 2):>10}                                                            â”‚",
                "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜",
            ])
        
        return "\n".join(lines)
    
    def _generate_fgi_bar(self, fgi_score: Optional[int]) -> str:
        """ç”ŸæˆFGIå¯è§†åŒ–æ¡"""
        if fgi_score is None:
            return "    [----æ•°æ®ç¼ºå¤±----]"
        
        total_width = 50
        position = int((fgi_score / 100) * total_width)
        
        # é¢œè‰²åŒºåŸŸ: æåº¦ææƒ§ | ææƒ§ | ä¸­æ€§ | è´ªå©ª | æåº¦è´ªå©ª
        bar = ""
        for i in range(total_width):
            if i == position:
                bar += "â–²"
            elif i < 12:  # æåº¦ææƒ§ 0-25
                bar += "â–ˆ" if i < position else "â–‘"
            elif i < 22:  # ææƒ§ 25-45
                bar += "â–“" if i < position else "â–‘"
            elif i < 28:  # ä¸­æ€§ 45-55
                bar += "â–’" if i < position else "â–‘"
            elif i < 38:  # è´ªå©ª 55-75
                bar += "â–“" if i < position else "â–‘"
            else:  # æåº¦è´ªå©ª 75-100
                bar += "â–ˆ" if i < position else "â–‘"
        
        return f"    0[{bar}]100"
    
    def format_technicals(self) -> str:
        """æ ¼å¼åŒ–æŠ€æœ¯é¢æ¨¡å—"""
        tech = self.snapshot.get("modules", {}).get("technicals", {})
        assets = tech.get("assets", {})
        
        lines = [
            "",
            "â•”" + "â•" * 98 + "â•—",
            "â•‘" + " " * 32 + "ğŸ“ˆ TECHNICALS (æŠ€æœ¯é¢)" + " " * 32 + "â•‘",
            "â•š" + "â•" * 98 + "â•",
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  ğŸ“Š ä¸»è¦èµ„äº§æŠ€æœ¯æŒ‡æ ‡                                                                               â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            "â”‚  èµ„äº§    â”‚   æ”¶ç›˜ä»·   â”‚   vs MA20   â”‚   vs MA50   â”‚   vs MA200   â”‚   ATR%    â”‚  å¸ƒæ—å®½åº¦ â”‚  è¶‹åŠ¿   â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
        ]
        
        trend_icons = {"uptrend": "ğŸ“ˆ", "downtrend": "ğŸ“‰", "range": "â†”ï¸"}
        
        for asset_name in ["SPX", "NDX", "RSP", "IWM", "XLK", "XLP", "XLU", "DXY", "GOLD", "CRUDE", "BTC"]:
            asset = assets.get(asset_name, {})
            if not asset:
                continue
            
            close = format_number(asset.get("close"), 2)
            ma20 = format_pct(asset.get("distance_ma20_pct"))
            ma50 = format_pct(asset.get("distance_ma50_pct"))
            ma200 = format_pct(asset.get("distance_ma200_pct"))
            atr = format_pct(asset.get("atr_pct"))
            boll = format_number(asset.get("boll_width"), 3)
            trend = asset.get("trend_label", "N/A")
            trend_icon = trend_icons.get(trend, "â“")
            
            lines.append(f"â”‚  {asset_name:8} â”‚ {close:>10} â”‚ {ma20:>11} â”‚ {ma50:>11} â”‚ {ma200:>12} â”‚ {atr:>9} â”‚ {boll:>9} â”‚ {trend_icon}{trend:6} â”‚")
        
        lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        
        # æ¨¡å—çº§æŒ‡æ ‡
        lines.extend([
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  ğŸ“Š æ¨¡å—çº§æŒ‡æ ‡                                                                                      â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
            f"â”‚    å¹¿åº¦å·®å¼‚ (RSP-SPX):      {format_pct(tech.get('breadth_diff')):>10}      {get_trend_emoji(tech.get('breadth_diff'))} {'å¹¿åº¦æ”¹å–„' if tech.get('breadth_diff') and tech.get('breadth_diff') > 0 else 'å¹¿åº¦æ¶åŒ–'}        â”‚",
            f"â”‚    é£æ ¼æ¯”ç‡ (XLK/XLP):      {format_number(tech.get('style_ratio'), 2):>10}      {'æˆé•¿å ä¼˜' if tech.get('style_ratio') and tech.get('style_ratio') > 1.5 else 'é˜²å¾¡å ä¼˜'}                   â”‚",
        ])
        
        # SPYæœŸæƒæ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
        if tech.get("options_pcr_volume") is not None:
            lines.extend([
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
                "â”‚  ğŸ“ˆ SPYæœŸæƒæŒ‡æ ‡                                                                                    â”‚",
                "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
                f"â”‚    PCR(æˆäº¤é‡):             {format_number(tech.get('options_pcr_volume'), 3):>10}                                                            â”‚",
                f"â”‚    PCR(æŒä»“é‡):             {format_number(tech.get('options_pcr_oi'), 3):>10}                                                            â”‚",
                f"â”‚    Callæˆäº¤é‡/OI:           {tech.get('total_call_volume', 'N/A'):>10} / {tech.get('total_call_oi', 'N/A'):<10}                                    â”‚",
                f"â”‚    Putæˆäº¤é‡/OI:            {tech.get('total_put_volume', 'N/A'):>10} / {tech.get('total_put_oi', 'N/A'):<10}                                    â”‚",
                f"â”‚    ATM IV (Call/Put):       {format_number(tech.get('atm_iv_call'), 3):>10} / {format_number(tech.get('atm_iv_put'), 3):<10}                                    â”‚",
                f"â”‚    IV Skew (Put-Call):      {format_number(tech.get('iv_skew'), 4):>10}      {'Putåé«˜' if tech.get('iv_skew') and tech.get('iv_skew') > 0.05 else 'Callåé«˜' if tech.get('iv_skew') and tech.get('iv_skew') < -0.02 else 'å¹³è¡¡'}          â”‚",
                f"â”‚    æœ€è¿‘åˆ°æœŸæ—¥:              {tech.get('near_expiry', 'N/A'):>10}                                                            â”‚",
            ])
        
        lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        
        return "\n".join(lines)
    
    def format_data_quality(self) -> str:
        """æ ¼å¼åŒ–æ•°æ®è´¨é‡æŠ¥å‘Š"""
        dq = self.snapshot.get("data_quality", {})
        
        lines = [
            "",
            "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”",
            "â”‚  âš ï¸ æ•°æ®è´¨é‡æŠ¥å‘Š (Data Quality)                                                                     â”‚",
            "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤",
        ]
        
        for module, missing in dq.items():
            if missing:
                lines.append(f"â”‚    {module:15} âŒ ç¼ºå¤±å­—æ®µ: {', '.join(missing)[:70]:70} â”‚")
            else:
                lines.append(f"â”‚    {module:15} âœ… æ•°æ®å®Œæ•´                                                         â”‚")
        
        lines.append("â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜")
        
        return "\n".join(lines)
    
    def format_llm_module_reports(self) -> str:
        """æ ¼å¼åŒ–LLMæ¨¡å—åˆ†ææŠ¥å‘Š"""
        reports = self.snapshot.get("llm_module_reports", {})
        if not reports:
            reports = self.llm_module_logs
        
        if not reports:
            return ""
        
        lines = [
            "",
            "=" * 100,
            "                     ğŸ¤– LLM æ¨¡å—åˆ†ææŠ¥å‘Š (Module Analysis Reports)",
            "=" * 100,
        ]
        
        module_names = {
            "fundamentals": "ğŸ“Š å®è§‚åŸºæœ¬é¢åˆ†æ",
            "liquidity": "ğŸ’§ æµåŠ¨æ€§åˆ†æ", 
            "sentiment": "ğŸ˜€ å¸‚åœºæƒ…ç»ªåˆ†æ",
            "technicals": "ğŸ“ˆ æŠ€æœ¯é¢åˆ†æ"
        }
        
        for module, report in reports.items():
            if isinstance(report, dict):
                text = report.get("text", "")
                model = report.get("llm_model", "Unknown")
            else:
                text = report
                model = "Unknown"
            
            if not text:
                continue
            
            lines.extend([
                "",
                "â”€" * 100,
                f"  {module_names.get(module, module)} (æ¨¡å‹: {model})",
                "â”€" * 100,
                "",
                text,
            ])
        
        return "\n".join(lines)
    
    def format_overall_report(self) -> str:
        """æ ¼å¼åŒ–LLMç»¼åˆæŠ¥å‘Š"""
        overall = self.snapshot.get("last_overall_report", "") or self.llm_overall_log
        
        if not overall:
            return ""
        
        model = self.snapshot.get("last_overall_report_model", "Unknown")
        
        lines = [
            "",
            "=" * 100,
            "                     ğŸ¯ LLM ç»¼åˆä¸“ä¸šåˆ†ææŠ¥å‘Š (Overall Professional Analysis)",
            f"                                    æ¨¡å‹: {model}",
            "=" * 100,
            "",
            overall,
        ]
        
        return "\n".join(lines)
    
    def generate_full_report(self) -> str:
        """ç”Ÿæˆå®Œæ•´æŠ¥å‘Š"""
        sections = [
            self.format_header(),
            self.format_labels_summary(),
            self.format_fundamentals(),
            self.format_liquidity(),
            self.format_sentiment(),
            self.format_technicals(),
            self.format_data_quality(),
            self.format_llm_module_reports(),
            self.format_overall_report(),
            "",
            "=" * 100,
            "                              ğŸ“„ æŠ¥å‘Šç»“æŸ (End of Report)",
            f"                          ç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            "=" * 100,
        ]
        
        return "\n".join(sections)


# ============================================================================
#                           æ–‡ä»¶æ“ä½œå‡½æ•°
# ============================================================================

def load_snapshot(snapshot_id: str) -> Optional[Dict]:
    """åŠ è½½å¿«ç…§æ–‡ä»¶"""
    snapshot_path = Path(DATA_DIR) / "snapshots" / f"{snapshot_id}.json"
    if not snapshot_path.exists():
        print(f"[ERROR] å¿«ç…§æ–‡ä»¶ä¸å­˜åœ¨: {snapshot_path}")
        return None
    
    with open(snapshot_path, "r", encoding="utf-8") as f:
        return json.load(f)

def load_llm_module_logs(snapshot_id: str) -> Dict[str, str]:
    """åŠ è½½LLMæ¨¡å—æ—¥å¿—"""
    logs = {}
    log_dir = Path(DATA_DIR) / "llm_logs" / "module" / snapshot_id
    
    if not log_dir.exists():
        return logs
    
    for module in ["fundamentals", "liquidity", "sentiment", "technicals"]:
        log_file = log_dir / f"{module}.jsonl"
        if log_file.exists():
            with open(log_file, "r", encoding="utf-8") as f:
                for line in f:
                    data = json.loads(line)
                    logs[module] = data.get("analysis", "")
    
    return logs

def load_llm_overall_log(snapshot_id: str) -> Optional[str]:
    """åŠ è½½LLMç»¼åˆåˆ†ææ—¥å¿—"""
    log_file = Path(DATA_DIR) / "llm_logs" / "overall" / snapshot_id / "events.jsonl"
    
    if not log_file.exists():
        return None
    
    with open(log_file, "r", encoding="utf-8") as f:
        for line in f:
            data = json.loads(line)
            return data.get("analysis", "")
    
    return None

def get_latest_snapshot_id() -> Optional[str]:
    """è·å–æœ€æ–°çš„å¿«ç…§ID"""
    snapshot_dir = Path(DATA_DIR) / "snapshots"
    if not snapshot_dir.exists():
        return None
    
    files = list(snapshot_dir.glob("*.json"))
    if not files:
        return None
    
    # æŒ‰ä¿®æ”¹æ—¶é—´æ’åº
    files.sort(key=lambda x: x.stat().st_mtime, reverse=True)
    return files[0].stem

def get_all_snapshot_ids() -> List[str]:
    """è·å–æ‰€æœ‰å¿«ç…§ID"""
    snapshot_dir = Path(DATA_DIR) / "snapshots"
    if not snapshot_dir.exists():
        return []
    
    files = list(snapshot_dir.glob("*.json"))
    files.sort(key=lambda x: x.stat().st_mtime, reverse=True)
    return [f.stem for f in files]

def save_report(report: str, snapshot_id: str):
    """ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶"""
    output_dir = Path(OUTPUT_DIR)
    output_dir.mkdir(exist_ok=True)
    
    output_file = output_dir / f"report_{snapshot_id}.txt"
    with open(output_file, "w", encoding="utf-8") as f:
        f.write(report)
    
    print(f"[OK] æŠ¥å‘Šå·²ä¿å­˜: {output_file}")
    return output_file


# ============================================================================
#                           ä¸»å‡½æ•°
# ============================================================================

def format_single_snapshot(snapshot_id: str) -> Optional[str]:
    """æ ¼å¼åŒ–å•ä¸ªå¿«ç…§"""
    print(f"[INFO] åŠ è½½å¿«ç…§: {snapshot_id}")
    
    snapshot = load_snapshot(snapshot_id)
    if not snapshot:
        print(f"[ERROR] å¿«ç…§æ–‡ä»¶ä¸å­˜åœ¨æˆ–åŠ è½½å¤±è´¥")
        return None
    
    llm_module_logs = load_llm_module_logs(snapshot_id)
    llm_overall_log = load_llm_overall_log(snapshot_id)
    
    formatter = SnapshotFormatter(snapshot, llm_module_logs, llm_overall_log)
    report = formatter.generate_full_report()
    
    return report

def main():
    """ä¸»å…¥å£"""
    if len(sys.argv) < 2:
        print("ç”¨æ³•:")
        print("  python format_snapshot.py <snapshot_id>    # æ ¼å¼åŒ–æŒ‡å®šå¿«ç…§")
        print("  python format_snapshot.py --latest         # æ ¼å¼åŒ–æœ€æ–°å¿«ç…§")
        print("  python format_snapshot.py --all            # æ ¼å¼åŒ–æ‰€æœ‰å¿«ç…§")
        print("  python format_snapshot.py --list           # åˆ—å‡ºæ‰€æœ‰å¿«ç…§")
        sys.exit(1)
    
    arg = sys.argv[1]
    
    if arg == "--list":
        ids = get_all_snapshot_ids()
        print(f"[LIST] æ‰¾åˆ° {len(ids)} ä¸ªå¿«ç…§:")
        for sid in ids:
            snapshot = load_snapshot(sid)
            if snapshot:
                print(f"  - {sid} (æ—¥æœŸ: {snapshot.get('date', 'N/A')})")
        sys.exit(0)
    
    if arg == "--latest":
        snapshot_id = get_latest_snapshot_id()
        if not snapshot_id:
            print("[ERROR] æœªæ‰¾åˆ°ä»»ä½•å¿«ç…§")
            sys.exit(1)
        report = format_single_snapshot(snapshot_id)
        if report:
            output_file = save_report(report, snapshot_id)
            print(f"\n[å®Œæˆ] æŠ¥å‘Šå·²ä¿å­˜ï¼Œè¯·ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€æŸ¥çœ‹: {output_file}")
    
    elif arg == "--all":
        ids = get_all_snapshot_ids()
        for sid in ids:
            report = format_single_snapshot(sid)
            if report:
                save_report(report, sid)
    
    else:
        # å‡è®¾æ˜¯å¿«ç…§ID
        report = format_single_snapshot(arg)
        if report:
            output_file = save_report(report, arg)
            print(f"\n[å®Œæˆ] æŠ¥å‘Šå·²ä¿å­˜ï¼Œè¯·ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€æŸ¥çœ‹: {output_file}")


if __name__ == "__main__":
    main()

